---
// =================================================================================
// 1. IMPORTS
// =================================================================================

// 1a. i18n & Language Utilities
import { useTranslations } from "@/i18n/utils.ts";
import type { Language } from "@/i18n/ui.ts";

// 1b. Project Configuration
import { i18n } from "@/config.ts";

// 1c. Layouts & Page Structure
import Base from "@/layouts/Base.astro";
import Hero from "@/layouts/blocks/Hero.astro";
import Stats from "@/layouts/blocks/Stats.astro";
import Headline from "@/components/ui-astro/Headline.astro";
import { MarqueeHome } from "@/layouts/blocks/MarqueeHome.tsx";

// 1d. UI Components
import CardNewsSm from "@/components/CardNewsSm.astro";
import Quote from "@/components/ui-astro/Quote.astro";
import InvitationModal from "@/components/InvitationModal.astro";

// 1e. Content & Data Utilities
import { getSinglePage } from "@/lib/contentParser.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import { cn } from "@/lib/utils.ts";

// =================================================================================
// 2. ROUTING & LANGUAGE VALIDATION
// =================================================================================

// Generate a static page for each supported language
export async function getStaticPaths() {
  return i18n.locales.map((lang) => ({
    params: { lang },
  }));
}

// Get and validate the language from the URL parameter
const { lang } = Astro.params;
if (!i18n.locales.includes(lang)) {
  throw new Error(
    `Invalid language: ${lang}. Check 'locales' in src/config.ts.`,
  );
}

// =================================================================================
// 3. DATA FETCHING & PROCESSING
// =================================================================================

// Initialize the translation function for the current language
const t = useTranslations(lang as Language);

// Fetch all news posts from the content folder
const NEWS_FOLDER = "news";
const allPosts = await getSinglePage(NEWS_FOLDER);

// Sort all posts, then filter by the current language, and take the 3 most recent
const currentPosts = sortByDate(allPosts)
  .filter((post) => post.id && post.id.startsWith(`${lang}/`))
  .slice(0, 3);

const ytPatternId = `pattern-${crypto.randomUUID().slice(0, 8)}`;

// =================================================================================
// 4. PAGE METADATA FOR INDEX
// =================================================================================

const content = {
  title: t("nav.home"),
  description: t("site.description"),
  image: "/og-images/champs-homepage.png", // NOTE: Create this social sharing image (1200x630px)
  imageAlt: t("hero.subtitle"),
  canonical: Astro.url.href,
};
---

<Base {content} makara={true}>
  <div class="bg-background">
    <Hero
      actions={[
        {
          text: t("hero.action.contact"),
          href: "https://wa.me/6281324096624",
          target: "_blank",
          icon: "FaWhatsapp",
          size: "lg",
        },
        {
          text: t("hero.action.expertise"),
          icon: "FaUsers",
          href: `/${lang}/what-we-do`,
          size: "lg",
        },
      ]}
      imageBg={{
        src: "/images/hero-bg.webp",
        height: 512,
        width: 1024,
        alt: "Hero Image",
      }}
    >
      <Fragment slot="tagline">{t("hero.tagline")}</Fragment>
      <Fragment slot="title">{t("hero.title")}</Fragment>
      <Fragment slot="subtitle">
        <span class="hidden sm:block">{t("hero.subtitle")}</span>
      </Fragment>
    </Hero>

    <section class="mx-auto mb-20 p-6 xl:gap-16">
      <MarqueeHome client:load />
    </section>
  </div>

  <div
    class="via-primary/30 h-px w-full bg-gradient-to-r from-transparent to-transparent"
  >
  </div>

  <Quote
    className="relative mx-auto my-3 w-fit max-w-4xl flex-nowrap text-center text-lg"
    quote={t("quote.champs")}
  />

  <Stats
    title={t("stats.title")}
    subtitle={t("stats.subtitle")}
    stats={[
      {
        title: t("stats.item1"),
        amount: "13",
        description: t("stats.description1"),
      },
      {
        title: t("stats.item2"),
        amount: "3",
        description: t("stats.description2"),
      },
      {
        title: t("stats.item3"),
        amount: "2",
        description: t("stats.description3"),
      },
      {
        title: t("stats.item4"),
        amount: "1",
        description: t("stats.description4"),
      },
    ]}
  />

  <div
    class="via-primary/30 h-px w-full bg-gradient-to-r from-transparent to-transparent"
  >
  </div>

  <section class="not-prose mx-auto my-20 max-w-6xl p-6">
    <article
      class={cn(
        "group hover:border-primary bg-background relative isolate flex flex-col gap-6 overflow-hidden rounded-xl border-2 p-6 duration-100 hover:[box-shadow:_var(--sh-alt)]",
      )}
    >
      {/* SVG background pattern */}
      <svg
        class="text-primary pointer-events-none invisible absolute inset-0 z-[-1] size-full [mask-image:linear-gradient(to_left,_#ffffffad,_transparent)] opacity-100 select-none group-hover:visible dark:opacity-80"
        aria-hidden="true"
      >
        <defs>
          <pattern
            id={ytPatternId}
            width="4"
            height="4"
            patternUnits="userSpaceOnUse"
            patternTransform="rotate(45)"
          >
            <line
              x1="0"
              y1="0"
              x2="0"
              y2="4"
              stroke="currentColor"
              stroke-width="1.5"></line>
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill={`url(#${ytPatternId})`}></rect>
      </svg>

      {/* Optional header (delete if you don't want it) */}
      <header class="space-y-2">
        <Headline title={t("video.title")} subtitle={t("video.subtitle")} />
      </header>

      {/* Media */}
      <div class="bg-muted/10 relative overflow-hidden rounded-lg border">
        <div class="relative aspect-video w-full">
          <iframe
            class="absolute inset-0 h-full w-full"
            src="https://www.youtube.com/embed/byjpp35gmXw?si=GkcNdr42RM0xRhSp"
            title="YouTube video player"
            frameborder="0"
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen></iframe>
        </div>
      </div>
    </article>
  </section>

  <div
    class="via-primary/30 h-px w-full bg-gradient-to-r from-transparent to-transparent"
  >
  </div>

  <!-- News posts cards -->
  <section
    class={cn(
      "intersect-once intersect-quarter intercept-no-queue motion-safe:md:intersect:animate-fade-in motion-safe:md:opacity-0",
      "mx-auto my-20 max-w-6xl p-6 xl:gap-16",
    )}
  >
    <header class="mb-4 flex flex-wrap items-baseline justify-between">
      <p class="text-3xl font-bold">{t("news.latest")}</p>
      <a class="link" href={`/${lang}/news`}>{t("news.all")}</a>
    </header>
    <div class="grid h-fit gap-4 lg:grid-cols-3">
      {
        currentPosts.map((post) => (
          <div class="col-span-1 mb-6">
            <CardNewsSm data={post} />
          </div>
        ))
      }
    </div>
  </section>

  <InvitationModal storageKey={`tna-invitation-${lang}`}>
    <h2 id="invitation-title" class="text-2xl font-semibold">
      {t("tna.modal.title")}
    </h2>

    <p class="text-muted-foreground mt-4">
      {t("tna.modal.description")}
    </p>

    <a
      href={`/${lang}/projects/tna-champs-ui`}
      class="bg-primary text-primary-foreground mt-6 inline-flex rounded-xl px-6 py-3 font-medium hover:opacity-90"
    >
      {t("tna.modal.cta")}
    </a>
  </InvitationModal>
</Base>
