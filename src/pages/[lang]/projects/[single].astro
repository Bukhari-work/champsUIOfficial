---
import { getSinglePage } from "@/lib/contentParser.astro";
import type { Language } from "@/i18n/ui.ts";
import { i18n } from "@/config.ts";
import { render } from "astro:content";

import ProjectPage from "@/layouts/ProjectsLayout.astro";
import DynamicIcon from "@/components/blocks/DynamicIcon.tsx";
import Button from "@/components/ui-astro/Button.astro";
import SpeakerCard from "@/components/CardSpeaker.astro";

// 1. Generate a page for every entry in the 'projects' collection
export async function getStaticPaths() {
  const PROJECTS_FOLDER = "projects";
  const posts = await getSinglePage(PROJECTS_FOLDER);

  // Create a path for each post, using the lang and slug from its own ID
  const paths = posts
    .map((post) => {
      const idParts = post.id.split("/"); // e.g., ['en', 'post-slug']

      // Basic validation
      if (idParts.length < 2) {
        console.warn(
          `[getStaticPaths] Skipping post with invalid ID: ${post.id}`,
        );
        return null;
      }

      const lang = idParts[0] as Language;
      const slug = idParts[1]; // Assumes slug is just the second part

      // Validate that the lang from the post ID is a valid locale
      if (!i18n.locales.includes(lang)) {
        console.warn(
          `[getStaticPaths] Skipping post with unknown lang '${lang}' in ID: ${post.id}`,
        );
        return null;
      }

      return {
        params: {
          lang: lang,
          single: slug,
        },
        props: { post },
      };
    })
    .filter((path) => path !== null); // Filter out any nulls from skipped posts

  return paths;
}

// 2. Get the 'project' prop for the current page
const { post } = Astro.props;
const { data } = post;

// 3. Get the MD/MDX content to render
// Optimize performance with parallel execution
const [renderedContent] = await Promise.all([render(post)]);

const { Content } = renderedContent;
---

<ProjectPage project={post}>
  <Fragment slot="main-content">
    <div
      class="not-prose bg-background dark:shadow-primary/20 rounded-2xl border p-8 shadow-lg"
    >
      <h2
        id="about"
        class="prose dark:prose-invert flex items-center gap-3 text-2xl font-bold"
      >
        <DynamicIcon icon="LuInfo" className="text-primary size-6" />
        <span
          >{
            Astro.params.lang === "en"
              ? "About the Workshop"
              : "Tentang Workshop"
          }</span
        >
      </h2>
      <div class="prose dark:prose-invert mt-4 max-w-none space-y-4">
        <Content />
      </div>

      <div class="border-primary bg-primary/10 mt-8 rounded-xl border p-6">
        <h3
          id="objectives"
          class="prose dark:prose-invert flex items-center gap-3 text-xl font-bold"
        >
          <DynamicIcon icon="FaListCheck" className="text-primary size-5" />
          <span>{data.takeaways.heading}</span>
        </h3>
        <p class="prose dark:prose-invert mt-2 max-w-none">
          {data.takeaways.intro}
        </p>
        <div class="mt-4 grid gap-3 sm:grid-cols-1">
          {
            data.takeaways.items.map((item) => (
              <div class="flex items-start gap-3">
                <DynamicIcon
                  icon="FaRegCircleCheck"
                  className="text-primary mt-1.5 size-4 flex-shrink-0"
                />
                <p class="m-0 text-base">{item}</p>
              </div>
            ))
          }
        </div>
      </div>
    </div>

    <div
      class="not-prose bg-background dark:shadow-primary/20 rounded-2xl border p-8 shadow-lg"
    >
      <h2
        id="audience"
        class="prose dark:prose-invert flex items-center gap-3 text-2xl font-bold"
      >
        <DynamicIcon icon="LuUsers" className="text-primary size-6" />
        <span>{data.audience.heading}</span>
      </h2>
      <div class="mt-4 grid gap-4">
        {
          data.audience.items.map((item) => (
            <div class="flex items-start gap-4">
              <DynamicIcon
                icon="LuUserCheck"
                className="text-primary mt-1 size-5 flex-shrink-0"
              />
              <p class="m-0">{item}</p>
            </div>
          ))
        }
      </div>
      {
        data.audienceNotes.map((note) => (
          <div class="border-primary bg-primary/10 mt-4 flex items-center gap-3 rounded-lg border p-4">
            <DynamicIcon icon={note.icon} className="size-6 flex-shrink-0" />
            <p class="m-0 text-sm" set:html={note.text} />
          </div>
        ))
      }
    </div>

    <div
      class="bg-background dark:shadow-primary/20 rounded-2xl border p-8 shadow-lg"
    >
      <h2
        id="speakers"
        class="prose dark:prose-invert flex items-center gap-3 text-2xl font-bold"
      >
        <DynamicIcon icon="LuSquareUserRound" className="text-primary size-6" />
        <span>{Astro.params.lang === "en" ? "Key Speakers" : "Narasumber"}</span
        >
      </h2>
      <div
        class="not-prose mt-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"
      >
        {
          data.speakers.map((speaker) => (
            <SpeakerCard
              name={speaker.name}
              title={speaker.title}
              imageMeta={speaker.image}
              imageAlt={speaker.image?.alt}
            />
          ))
        }
      </div>
    </div>
  </Fragment>

  <Fragment slot="sidebar">
    <h3 class="mb-4 text-xl font-bold">{data.sidebarDetails.heading}</h3>
    <ul class="mb-4 space-y-3">
      {
        data.sidebarDetails.items.map((item) => (
          <li class="flex items-center gap-3">
            <DynamicIcon icon={item.icon} className="text-primary h-5 w-5" />
            <span>{item.text}</span>
          </li>
        ))
      }
    </ul>

    <h4 class="mt-8 mb-4 text-lg font-semibold">{data.sidebarFee.heading}</h4>
    <div class="space-y-3">
      {
        data.sidebarFee.items.map((item) => (
          <div class="bg-background flex items-center justify-between rounded-lg border p-4">
            <div>
              {item.icon && (
                <p class="flex items-center gap-2 font-bold text-gray-800 dark:text-gray-200">
                  <DynamicIcon icon={item.icon} className="size-4" />
                </p>
              )}
              {item.details && (
                <p class="text-sm text-gray-500 dark:text-gray-400">
                  {item.details}
                </p>
              )}
            </div>
            <p
              class:list={[
                "text-lg font-semibold",
                Astro.params.lang === "id" && "text-primary", // Specific style for 'ai.astro'
              ]}
            >
              {item.price}
            </p>
          </div>
        ))
      }
    </div>
    <p
      class="mt-3 text-sm text-gray-600 dark:text-gray-400"
      set:html={data.sidebarFee.includes}
    />
    <p
      class="mt-3 text-sm text-gray-600 dark:text-gray-400"
      set:html={data.sidebarFee.excludes}
    />

    <div class="mt-6 text-center">
      <Button href={data.sidebarRegister.href} target="_blank">
        {data.sidebarRegister.buttonText}
      </Button>
      <p class="mt-2 text-sm">{data.sidebarRegister.deadline}</p>
    </div>
    <!-- <Image
      src={data.sidebarRegister.qrCode.src}
      alt={data.sidebarRegister.qrCode.alt}
      class="mx-auto mt-4 w-48 rounded-lg"
    /> -->

    <div class="mt-6 border-t pt-4 text-center">
      <p class="text-sm text-gray-600 dark:text-gray-400">
        {data.sidebarContact.heading}
      </p>
      <div class="mt-2 flex flex-col items-center gap-1">
        {
          data.sidebarContact.links.map((link) => (
            <a
              href={link.href}
              target="_blank"
              rel="noopener noreferrer"
              class="hover:text-primary inline-flex items-center gap-2 transition"
            >
              <DynamicIcon icon={link.icon} className="size-5" />
              <span class="link">{link.text}</span>
            </a>
          ))
        }
      </div>
    </div>
  </Fragment>
</ProjectPage>
