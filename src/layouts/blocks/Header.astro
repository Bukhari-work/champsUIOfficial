---
import { navigation } from "@/navigation.ts";
import { i18n } from "@/config.ts";
import { ui } from "@/i18n/ui";
import type { Language } from "@/i18n/ui.ts";
import { useTranslations } from "@/i18n/utils.ts";
import ThemeToggle from "@/components/ThemeToggle.astro";
import NavDrawer from "@/components/NavDrawer.astro";
import Button from "@/components/ui-astro/Button.astro";
import { Image } from "astro:assets";
import LanguageToggle from "@/components/LanguageToggle.astro";

type TranslationKeys = keyof (typeof ui)[typeof i18n.defaultLocale];

const { lang } = Astro.params;
const t = useTranslations(lang as Language);

const nav = navigation[lang as keyof typeof navigation];
const homeUrl = nav.header[0]?.href || `/${lang}/`;

const normalize = (p: string) => (p === "/" ? "/" : p.replace(/\/+$/, ""));
const pathname = normalize(Astro.url.pathname);
const isActiveHref = (href?: string) => {
  if (!href) return false;
  const target = normalize(href);

  // Treat "/{lang}" and "/{lang}/" as the home route
  const homeA = normalize(`/${lang}`);
  const homeB = normalize(`/${lang}/`);
  const isHome = target === homeA || target === homeB;

  if (isHome) return pathname === homeA || pathname === homeB;

  return pathname === target || pathname.startsWith(`${target}/`);
};
---

<header
  id="site-header"
  data-scrolled="false"
  class:list={[
    // Layout
    "fixed inset-x-0 top-0 z-30 w-screen",
    // Visuals (default: subtle, no border)
    "bg-background/40 supports-[backdrop-filter]:bg-background/60 backdrop-blur-sm",
    "border-b border-transparent",
    // When scrolled (toggled via data attribute)
    "data-[scrolled=true]:border-border/100",
  ]}
>
  <div class="relative mx-3 flex h-full grow md:mx-8 lg:mx-12">
    <nav
      aria-label="Main navigation"
      class="mx-auto flex h-16 w-full items-center justify-between px-3 md:max-w-7xl md:px-6"
    >
      <a href={homeUrl} class="flex items-center" aria-label="Homepage">
        <span class="sr-only">Homepage</span>

        <!-- Dark mode logo -->
        <Image
          src="/images/Logo-landscape-black.webp"
          alt="Company Logo"
          width={150}
          height={48}
          class="hidden p-2 transition-transform duration-300 hover:scale-105 dark:block"
          loading="eager"
          decoding="async"
        />

        <!-- Light mode logo -->
        <Image
          src="/images/Logo-landscape-white.webp"
          alt="Company Logo"
          width={150}
          height={48}
          class="block p-2 transition-transform duration-300 hover:scale-105 dark:hidden"
          loading="eager"
          decoding="async"
        />
      </a>

      <div id="desktop-menu" class="hidden items-center lg:flex">
        <ul
          id="navigation"
          class="inline-flex w-auto flex-wrap justify-center space-x-1 self-center px-5 text-center text-sm"
        >
          {
            nav.header.map((menu) => {
              const isHome = menu.href === `/${lang}`;
              const isActive = isHome
                ? pathname === `/${lang}`
                : menu.href && pathname.startsWith(menu.href.toString());

              return (
                <li>
                  <a
                    href={menu.href}
                    class:list={[
                      "text-foreground/80 group hover:bg-primary/12 relative block gap-10 rounded-xl px-4 py-3",
                      {
                        "text-primary/80 bg-primary/12": isActive,
                      },
                    ]}
                    aria-current={isActive ? "page" : undefined}
                  >
                    {t(menu.textKey)}
                  </a>
                </li>
              );
            })
          }
        </ul>

        {
          nav.callToAction && (
            <Button
              size="default"
              className="my-auto bg-primary/80 transition-colors duration-200"
              href={nav.callToAction.href}
            >
              {t(nav.callToAction.textKey)}
            </Button>
          )
        }

        <ThemeToggle className="mx-2 self-center" />
        <LanguageToggle />
      </div>

      <div id="mobile-menu" class="flex items-center gap-2 lg:hidden">
        {
          nav.callToAction && (
            <Button
              size="sm"
              className="mr-2 bg-primary/60 align-middle transition-colors duration-200"
              href={nav.callToAction.href}
            >
              {t(nav.callToAction.textKey)}
            </Button>
          )
        }
        <Button
          icon="LuMenu"
          variant="outline"
          size="sm"
          data-aw-show-nav
          className="align-middle"
          aria-label="Open menu"
        />
      </div>
    </nav>
    <div
      class="bg-background border-primary absolute -bottom-1 -left-1 z-10 h-2 w-2 rotate-45 border"
    >
    </div>
    <div
      class="bg-background border-primary absolute -right-1 -bottom-1 z-10 h-2 w-2 rotate-45 border"
    >
    </div>
  </div>
</header>

<NavDrawer lang={lang} />

<script is:inline>
  (() => {
    let cleanup;

    const setup = () => {
      const header = document.getElementById("site-header");
      if (!header) return;

      const threshold = 8;
      let ticking = false;

      const update = () => {
        const scrolled = window.scrollY > threshold;
        header.dataset.scrolled = scrolled ? "true" : "false";
      };

      const onScroll = () => {
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(() => {
          ticking = false;
          update();
        });
      };

      update();
      window.addEventListener("scroll", onScroll, { passive: true });

      cleanup = () => {
        window.removeEventListener("scroll", onScroll);
      };
    };

    const run = () => {
      cleanup?.();
      setup();
    };

    // Initial load
    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", run, { once: true });
    } else {
      run();
    }

    // Astro client-side navigation
    document.addEventListener("astro:after-swap", run);
    document.addEventListener("astro:before-swap", () => cleanup?.());
  })();
</script>
